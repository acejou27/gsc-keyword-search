name: ğŸ” GSCé—œéµå­—æœç´¢

on:
  # å®šæ™‚åŸ·è¡Œ - æ¯6å°æ™‚åŸ·è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */6 * * *'
  
  # æ‰‹å‹•è§¸ç™¼ - æä¾›æ›´å‹å¥½çš„ç•Œé¢
  workflow_dispatch:
    inputs:
      search_mode:
        description: 'æœç´¢æ¨¡å¼'
        required: true
        default: 'csv'
        type: choice
        options:
        - csv
        - manual
      search_query:
        description: 'æœç´¢è© (æ‰‹å‹•æ¨¡å¼)'
        required: false
        default: 'Python æ•™å­¸'
      target_keywords:
        description: 'ç›®æ¨™é—œéµå­— (æ‰‹å‹•æ¨¡å¼ï¼Œç”¨é€—è™Ÿåˆ†éš”)'
        required: false
        default: 'Django,Flask,FastAPI'
      max_pages:
        description: 'æœ€å¤§æœç´¢é æ•¸'
        required: false
        default: '5'
        type: choice
        options:
        - '3'
        - '5'
        - '10'
        - '15'
      enable_notifications:
        description: 'å•Ÿç”¨çµæœé€šçŸ¥'
        required: false
        default: true
        type: boolean
  
  # è‡ªå‹•è§¸ç™¼ - ç•¶é—œéµå­—æ–‡ä»¶æ›´æ–°æ™‚
  push:
    paths:
      - 'keywords.csv'
      - 'keywords-*.csv'
      - '.github/workflows/keyword-search.yml'
  
  # Pull Request è§¸ç™¼ - ç”¨æ–¼æ¸¬è©¦
  pull_request:
    paths:
      - 'keywords.csv'
      - 'keywords-*.csv'

jobs:
  search:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: ğŸ“ å‰µå»ºå¿…è¦ç›®éŒ„
      run: |
        mkdir -p results reports
    
    - name: ğŸ“¦ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: ğŸ”§ å®‰è£ä¾è³´
      run: |
        npm install puppeteer csv-parser
        # å®‰è£ç€è¦½å™¨ä¾è³´
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk chromium-browser
    
    - name: ğŸ“‹ æª¢æŸ¥æœç´¢æ¨¡å¼
      id: check_mode
      run: |
        if [ "${{ github.event.inputs.search_mode }}" = "manual" ]; then
          echo "mode=manual" >> $GITHUB_OUTPUT
        else
          echo "mode=csv" >> $GITHUB_OUTPUT
        fi
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ keywords.csv æ–‡ä»¶
        if [ -f "keywords.csv" ]; then
          echo "csv_exists=true" >> $GITHUB_OUTPUT
        else
          echo "csv_exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ” åŸ·è¡Œé—œéµå­—æœç´¢
      id: search
      run: |
        echo "ğŸš€ é–‹å§‹åŸ·è¡Œæœç´¢..."
        # æš«æ™‚ä½¿ç”¨ç°¡åŒ–ç‰ˆæœ¬é€²è¡Œæ¸¬è©¦
        node .github/scripts/simple-search.js
      env:
        SEARCH_MODE: ${{ steps.check_mode.outputs.mode }}
        SEARCH_QUERY: ${{ github.event.inputs.search_query }}
        TARGET_KEYWORDS: ${{ github.event.inputs.target_keywords }}
        MAX_PAGES: ${{ github.event.inputs.max_pages || '5' }}
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_RUN_NUMBER: ${{ github.run_number }}
    
    - name: ğŸ“Š ç”Ÿæˆæœç´¢å ±å‘Š
      if: success()
      run: |
        echo "ğŸ“Š å ±å‘Šå·²åœ¨æœç´¢æ­¥é©Ÿä¸­ç”Ÿæˆ"
    
    - name: ğŸ“ å‰µå»ºçµæœæ‘˜è¦
      if: success()
      run: |
        echo "## ğŸ” æœç´¢çµæœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "results/latest.json" ]; then
          node -e "
            const data = JSON.parse(require('fs').readFileSync('results/latest.json', 'utf8'));
            console.log(\`- **åŸ·è¡Œæ™‚é–“**: \${new Date(data.timestamp).toLocaleString('zh-TW')}\`);
            console.log(\`- **ç¸½æœç´¢æ¬¡æ•¸**: \${data.totalSearches}\`);
            console.log(\`- **æˆåŠŸæœç´¢**: \${data.successfulSearches}\`);
            console.log(\`- **æˆåŠŸç‡**: \${Math.round((data.successfulSearches / data.totalSearches) * 100)}%\`);
          " >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“ˆ [æŸ¥çœ‹è©³ç´°å ±å‘Š](./reports/latest-report.html)" >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ’¾ ä¸Šå‚³çµæœåˆ° Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: search-results-${{ github.run_number }}
        path: |
          results/
          reports/
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ“¤ æäº¤çµæœåˆ°å€‰åº«
      if: success() && github.event_name != 'pull_request'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ·»åŠ çµæœæ–‡ä»¶
        git add results/ reports/ README.md
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²’æœ‰æ–°çš„æœç´¢çµæœéœ€è¦æäº¤"
        else
          # å‰µå»ºæäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ” æœç´¢çµæœæ›´æ–° - $(date '+%Y-%m-%d %H:%M:%S')
          
          ğŸ¤– ç”± GitHub Actions è‡ªå‹•åŸ·è¡Œ
          ğŸ‘¤ è§¸ç™¼è€…: ${{ github.actor }}
          ğŸ”¢ é‹è¡Œç·¨è™Ÿ: ${{ github.run_number }}
          ğŸ“Š æœç´¢æ¨¡å¼: ${{ steps.check_mode.outputs.mode }}"
          
          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… æœç´¢çµæœå·²æäº¤åˆ°å€‰åº«"
        fi
    
    - name: ğŸ”” å‰µå»ºæˆåŠŸé€šçŸ¥ Issue
      if: success() && github.event.inputs.enable_notifications == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // è®€å–æœ€æ–°çµæœ
          const fs = require('fs');
          let resultSummary = 'ç„¡æ³•è®€å–çµæœæ‘˜è¦';
          
          try {
            if (fs.existsSync('results/latest.json')) {
              const data = JSON.parse(fs.readFileSync('results/latest.json', 'utf8'));
              resultSummary = `
              - **åŸ·è¡Œæ™‚é–“**: ${new Date(data.timestamp).toLocaleString('zh-TW')}
              - **ç¸½æœç´¢æ¬¡æ•¸**: ${data.totalSearches}
              - **æˆåŠŸæœç´¢**: ${data.successfulSearches}
              - **æˆåŠŸç‡**: ${Math.round((data.successfulSearches / data.totalSearches) * 100)}%
              - **åŸ·è¡Œæ™‚é•·**: ${Math.round(data.duration / 1000)}ç§’
              `;
            }
          } catch (error) {
            console.log('è®€å–çµæœæ–‡ä»¶æ™‚å‡ºéŒ¯:', error);
          }
          
          // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„é€šçŸ¥ Issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'search-notification',
            state: 'open'
          });
          
          // å¦‚æœæœ‰é–‹å•Ÿçš„é€šçŸ¥ Issueï¼Œå…ˆé—œé–‰å®ƒå€‘
          for (const issue of issues.data) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
          }
          
          // å‰µå»ºæ–°çš„é€šçŸ¥ Issue
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `âœ… é—œéµå­—æœç´¢å®Œæˆ - ${new Date().toLocaleDateString('zh-TW')}`,
            body: `
              ## ğŸ‰ æœç´¢ä»»å‹™æˆåŠŸå®Œæˆï¼
              
              **è§¸ç™¼è€…**: @${context.actor}
              **é‹è¡Œç·¨è™Ÿ**: #${context.runNumber}
              **åŸ·è¡Œæ™‚é–“**: ${new Date().toLocaleString('zh-TW')}
              
              ## ğŸ“Š çµæœæ‘˜è¦
              ${resultSummary}
              
              ## ğŸ”— ç›¸é—œé€£çµ
              - ğŸ“ˆ [æŸ¥çœ‹è©³ç´°å ±å‘Š](./reports/latest-report.html)
              - ğŸ“‹ [ä¸‹è¼‰çµæœæ–‡ä»¶](../../actions/runs/${context.runId})
              - ğŸ” [æŸ¥çœ‹åŸ·è¡Œæ—¥èªŒ](../../actions/runs/${context.runId})
              
              ---
              
              *æ­¤ Issue ç”± GitHub Actions è‡ªå‹•å‰µå»ºï¼Œæœƒåœ¨ä¸‹æ¬¡æœç´¢å®Œæˆæ™‚è‡ªå‹•é—œé–‰ã€‚*
            `,
            labels: ['search-notification', 'automated', 'success']
          });
    
    - name: ğŸš¨ å‰µå»ºå¤±æ•—é€šçŸ¥ Issue
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ é—œéµå­—æœç´¢å¤±æ•—',
            body: `
              ## âŒ æœç´¢ä»»å‹™åŸ·è¡Œå¤±æ•—
              
              **è§¸ç™¼è€…**: @${context.actor}
              **é‹è¡Œç·¨è™Ÿ**: #${context.runNumber}
              **å¤±æ•—æ™‚é–“**: ${new Date().toLocaleString('zh-TW')}
              **æœç´¢æ¨¡å¼**: ${{ steps.check_mode.outputs.mode }}
              
              ## ğŸ” å¯èƒ½çš„åŸå› 
              - Google åçˆ¬èŸ²æ©Ÿåˆ¶è§¸ç™¼
              - ç¶²çµ¡é€£æ¥å•é¡Œ
              - keywords.csv æ ¼å¼éŒ¯èª¤
              - ç³»çµ±è³‡æºä¸è¶³
              
              ## ğŸ› ï¸ å»ºè­°è§£æ±ºæ–¹æ¡ˆ
              1. æª¢æŸ¥ [åŸ·è¡Œæ—¥èªŒ](../../actions/runs/${context.runId}) ç²å–è©³ç´°éŒ¯èª¤ä¿¡æ¯
              2. é©—è­‰ keywords.csv æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¢º
              3. ç­‰å¾…ä¸€æ®µæ™‚é–“å¾Œé‡æ–°åŸ·è¡Œ
              4. è€ƒæ…®é™ä½æœç´¢é »ç‡æˆ–æ¸›å°‘é—œéµå­—æ•¸é‡
              
              ## ğŸ”— ç›¸é—œé€£çµ
              - ğŸ” [æŸ¥çœ‹åŸ·è¡Œæ—¥èªŒ](../../actions/runs/${context.runId})
              - ğŸ“ [ç·¨è¼¯é—œéµå­—æ–‡ä»¶](./keywords.csv)
              - ğŸ”„ [é‡æ–°åŸ·è¡Œæœç´¢](../../actions/workflows/keyword-search.yml)
              
              ---
              
              *è«‹æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒä¸¦ä¿®å¾©å•é¡Œå¾Œé‡æ–°åŸ·è¡Œæœç´¢ã€‚*
            `,
            labels: ['bug', 'automated', 'search-failure'],
            assignees: [context.actor]
          });

  notify:
    needs: search
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ç™¼é€é€šçŸ¥ (å¯é¸)
      if: needs.search.result == 'success'
      run: |
        echo "æœç´¢ä»»å‹™å®Œæˆï¼çµæœå·²ä¿å­˜åˆ°å€‰åº«ã€‚"
        # é€™è£¡å¯ä»¥æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚ Slackã€Discord ç­‰